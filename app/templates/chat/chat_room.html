{% extends 'base.html' %}

{% block content %}
<div class="container">
  <div class="row">
    <div class="col-md-8">
      <h1>{{ chat_room.name }}</h1>
      <div id="chat-messages" style="height: 400px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px;">
        {% for message in messages %}
          <p><strong>{{ message.sender.name }}:</strong> {{ message.content }} <small>({{ message.timestamp.strftime('%Y-%m-%d %H:%M:%S') }})</small></p>
        {% endfor %}
      </div>
      <form id="message-form">
        <div class="form-group">
          <input type="text" id="message-input" class="form-control" placeholder="메시지를 입력하세요...">
        </div>
        <button type="submit" class="btn btn-primary">전송</button>
      </form>
    </div>
    <div class="col-md-4">
      <h3>참여자 목록</h3>
      <ul class="list-group">
        {% for participant in chat_room.participants %}
          <li class="list-group-item">
            {{ participant.name }}
            {% if participant.id == chat_room.creator_id %}
              <span class="badge badge-primary">방장</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const socket = io();
  const chatMessages = document.getElementById('chat-messages');
  const messageForm = document.getElementById('message-form');
  const messageInput = document.getElementById('message-input');

  if (chatMessages && messageForm && messageInput) {
    socket.on('connect', function() {
      socket.emit('join', {room: '{{ chat_room.id }}'});
    });

    socket.on('message', function(data) {
      const p = document.createElement('p');
      p.innerHTML = `<strong>${data.username}:</strong> ${data.content} <small>(${data.timestamp})</small>`;
      chatMessages.appendChild(p);
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });

    messageForm.addEventListener('submit', function(e) {
      e.preventDefault();
      if (messageInput.value) {
        socket.emit('message', {room: '{{ chat_room.id }}', msg: messageInput.value});
        messageInput.value = '';
      }
    });
  }
});
</script>
{% endblock %}