{% extends 'base.html' %}

{% block content %}
<div class="project-detail">
<h2>{{ project.title }}</h2>
<p>{{ project.description }}</p>
<p>의뢰자: {{ project.client.name }}</p>

{% if project.github_repo %}
<p>GitHub 리포지토리: <a href="https://github.com/{{ project.github_repo }}" target="_blank">{{ project.github_repo }}</a></p>
{% endif %}

{% if current_user in project.participants or current_user == project.client %}
<a href="{{ url_for('project.plan', project_id=project.id) }}" class="btn btn-info">기획 페이지</a>
<a href="{{ url_for('project.feedback', project_id=project.id) }}" class="btn btn-info">피드백</a>
<a href="{{ url_for('project.save_code', project_id=project.id) }}" class="btn btn-primary">코드 저장</a>
{% endif %}

{% if current_user != project.client %}
  {% if not project.completed %}
    {% set participant = project.project_participants|selectattr('user', 'equalto', current_user)|first %}
    {% if not participant %}
    <form action="{{ url_for('project.participate', project_id=project.id) }}" method="post">
      {{ participate_form.csrf_token }}
      {{ participate_form.submit(class="btn btn-primary") }}
    </form>
    {% elif not participant.accepted %}
    <p>참가 신청 대기 중입니다.</p>
    {% endif %}
  {% endif %}
{% endif %}

<p>참여자:
{% for participant in project.participants %}
    {{ participant.name }}{% if not loop.last %}, {% endif %}
{% endfor %}
</p>

{% if current_user.id == project.client_id %}
  <h4>참가 신청 목록</h4>
  <ul>
    {% for participant in project.project_participants %}
      {% if not participant.accepted %}
        <li>
            {{ participant.user.name }}
            <form action="{{ url_for('project.accept_participant', project_id=project.id) }}" method="post" class="d-inline">
                {{ accept_form.csrf_token }}
                <input type="hidden" name="user_id" value="{{ participant.user.id }}">
                {{ accept_form.submit(class='btn btn-sm btn-success') }}
            </form>
        </li>
      {% endif %}
    {% endfor %}
  </ul>
{% endif %}

{% if not project.completed %}
    {% if current_user.id == project.client_id %}
    <a href="{{ url_for('project.complete_project', project_id=project.id) }}" class="btn btn-success">완료하기</a>
    {% endif %}
{% else %}
<p>프로젝트 완료</p>
{% endif %}

<hr>

<h3>참여자 기여 시간</h3>
<ul>
  {% for participant in project.project_participants %}
    <li>{{ participant.user.name }}: {{ participant.hours_contributed }} 시간</li>
  {% endfor %}
</ul>

{% if current_user in project.participants %}
  <h4>참여 시간 기록</h4>
  <form action="{{ url_for('project.contribute', project_id=project.id) }}" method="post">
    {{ contribution_form.csrf_token }}
    <div class="form-group">
      {{ contribution_form.hours.label }}
      {{ contribution_form.hours(class="form-control") }}
    </div>
    {{ contribution_form.submit(class="btn btn-primary") }}
  </form>
{% endif %}

<h2>{{ project.title }} - 진행상황 기록</h2>


<button id="toggle-progress-form" class="btn btn-primary mb-3">진행상황 작성하기</button>

<div id="progress-form-container" style="display: none;">
  <form method="POST" enctype="multipart/form-data" id="progress-form">
      {{ progress_form.csrf_token }}
      <div class="form-group">
          {{ progress_form.date.label }}
          {{ progress_form.date(class="form-control") }}
      </div>
      <div class="form-group">
          {{ progress_form.description.label }}
          {{ progress_form.description(class="form-control", rows="5", id="description-field", placeholder="이미지를 붙여넣기 하세요...") }}
      </div>
      <div class="form-group">
          {{ progress_form.image.label }}
          {{ progress_form.image(class="form-control-file") }}
      </div>
      <div class="form-group">
          {{ progress_form.ai_conversation_link.label }}
          {{ progress_form.ai_conversation_link(class="form-control", placeholder="GPT 대화 공유 링크를 입력하세요") }}
      </div>
      <div class="form-group">
          {{ progress_form.ai_conversation_file.label }}
          {{ progress_form.ai_conversation_file(class="form-control-file") }}
      </div>
      {{ progress_form.submit(class="btn btn-primary") }}
  </form>
</div>

<hr>

<h3>진행상황 목록</h3>
{% for progress in progress_list %}
<div class="card my-3">
    <div class="card-body">
        <h5 class="card-title">{{ progress.date.strftime('%Y-%m-%d') }}</h5>
        <p class="card-text">{{ progress.description|safe }}</p>
        {% if progress.image %}
        <img src="{{ url_for('uploaded_file', filename=progress.image) }}" class="img-fluid" alt="Progress Image">
        {% endif %}
        {% if progress.ai_conversation_link %}
        <p><a href="{{ progress.ai_conversation_link }}" target="_blank">GPT 대화 링크</a></p>
        {% endif %}
        {% if progress.ai_conversation_file %}
        <p><a href="{{ url_for('uploaded_file', filename=progress.ai_conversation_file) }}" target="_blank">Claude 대화 내역</a></p>
        {% endif %}
    </div>
</div>
{% endfor %}

<script>
  document.addEventListener('DOMContentLoaded', function() {
      var toggleButton = document.getElementById('toggle-progress-form');
      var formContainer = document.getElementById('progress-form-container');
  
      if (toggleButton && formContainer) {
          toggleButton.addEventListener('click', function() {
              if (formContainer.style.display === 'none') {
                  formContainer.style.display = 'block';
                  toggleButton.textContent = '진행상황 작성 취소';
              } else {
                  formContainer.style.display = 'none';
                  toggleButton.textContent = '진행상황 작성하기';
              }
          });
      }
  
      document.getElementById('description-field').addEventListener('paste', function(event) {
          var items = (event.clipboardData || event.originalEvent.clipboardData).items;
          for (var index in items) {
              var item = items[index];
              if (item.kind === 'file' && item.type.indexOf('image') !== -1) {
                  var file = item.getAsFile();
                  var formData = new FormData();
                  formData.append('image', file);
  
                  fetch('{{ url_for("project.upload_image") }}', {
                      method: 'POST',
                      body: formData,
                      headers: {
                          'X-CSRFToken': '{{ progress_form.csrf_token._value() }}'
                      }
                  })
                  .then(response => response.json())
                  .then(data => {
                      if (data.url) {
                          var img = document.createElement('img');
                          img.src = data.url;
                          document.getElementById('description-field').value += '\n<img src="' + data.url + '">\n';
                      }
                  })
                  .catch(error => {
                      console.error('Error uploading image:', error);
                  });
  
                  event.preventDefault();
              }
          }
      });
  });
  </script>
</div>
{% endblock %}